import{a as q,b as j,c as K,d as J,e as we,f as D,g as V,h as G,i as ee,j as ce,k as w,l as H,m as Q,n as W,o as Me,p as te,q as xe,r as Ae}from"./chunk-LZTZLAZF.js";import{i as ge,k as T,t as De,w as Fe}from"./chunk-WVZWHAHI.js";import{d as ae,n as ve}from"./chunk-6QGFZL3G.js";import{j as ye}from"./chunk-Q4G5UL72.js";import"./chunk-3XT5P2HO.js";function ie(n){return n*n*n*(10-n*(15-6*n))}var Ee=new xe,Pe=new w({color:4473924,side:K}),Ge=new w({color:13421772,side:j,transparent:!0,opacity:.75}),ne=new w({visible:!1}),Oe=new w({color:4513228}),Ue=new w({color:16776618}),Be=new w({color:4513228,side:j,transparent:!0,opacity:.5}),Ie=new w({color:16775545,side:j,transparent:!0,opacity:.5}),L=class{constructor(t,e,r,i,s,o){this.vector=t;this.fromZ=e;this.color=r;this.dimColor=i;this.hintOpacityScale=s;this.stickerMaterial={regular:new w({color:r,side:q}),dim:new w({color:i,side:q}),oriented:Oe,experimentalOriented2:Ue,ignored:Pe,invisible:ne},this.hintStickerMaterial={regular:new w({color:o?.hintColor??r,side:j,transparent:!0,opacity:.5*s}),dim:new w({color:o?.hintDimColor??i,side:j,transparent:!0,opacity:.5*s}),oriented:Be,experimentalOriented2:Ie,ignored:Ge,invisible:ne}}stickerMaterial;hintStickerMaterial},O=[new L(new D(0,1,0),new G(-T/4,0,0),16777215,14540253,1.25),new L(new D(-1,0,0),new G(0,-T/4,0),16746496,8930304,1,{hintDimColor:10053120}),new L(new D(0,0,1),new G(0,0,0),65280,34816,1,{hintDimColor:39168}),new L(new D(1,0,0),new G(0,T/4,0),16711680,6684672,1,{hintDimColor:10027008}),new L(new D(0,0,-1),new G(0,T/2,0),2254591,1127304,.75,{hintDimColor:6246}),new L(new D(0,-1,0),new G(T/4,0,0),16776960,8947712,1.25,{hintDimColor:12303104})],d={U:0,L:1,F:2,R:3,B:4,D:5},He={U:d.U,u:d.U,Uw:d.U,Uv:d.U,y:d.U,L:d.L,l:d.L,Lw:d.L,Lv:d.L,M:d.L,F:d.F,f:d.F,Fw:d.F,Fv:d.F,S:d.F,z:d.F,R:d.R,r:d.R,Rw:d.R,Rv:d.R,x:d.R,B:d.B,b:d.B,Bw:d.B,Bv:d.B,D:d.D,d:d.D,Dw:d.D,Dv:d.D,E:d.D},_={stickerElevation:.503,foundationWidth:1,hintStickerElevation:1.45},Le=2;var Ne={showMainStickers:!0,hintFacelets:"floating",showFoundation:!0,experimentalStickeringMask:void 0,foundationSprite:null,hintSprite:null,initialHintFaceletsAnimation:"auto",faceletScale:"auto"},je=.85;function le(n){return typeof n.faceletScale>"u"||n.faceletScale==="auto"?je:n.faceletScale}var Ve=new w({color:0,opacity:1,transparent:!0}),We=new w({color:0,opacity:.3,transparent:!0}),S=class{constructor(t,e,r){this.orbit=t;let i=typeof e=="string"?e.split(""):e;this.stickerFaces=i.map(s=>d[s]),this.matrix=new V,this.matrix.setPosition(se[t]),this.matrix.premultiply(new V().makeRotationFromQuaternion(r))}matrix;stickerFaces};function h(n,t){return new we().setFromAxisAngle(n,T*t/4)}var p={O:new D(0,0,0),U:new D(0,-1,0),L:new D(1,0,0),F:new D(0,0,-1),R:new D(-1,0,0),B:new D(0,0,1),D:new D(0,1,0)},se={EDGES:new D(0,1,1),CORNERS:new D(1,1,1),CENTERS:new D(0,1,0)},_e={EDGES:[0,1].map(n=>new V().makeRotationAxis(se.EDGES.clone().normalize(),-n*T/2)),CORNERS:[0,1,2].map(n=>new V().makeRotationAxis(se.CORNERS.clone().normalize(),-n*T/3)),CENTERS:[0,1,2,3].map(n=>new V().makeRotationAxis(se.CENTERS.clone().normalize(),-n*T/4))},ue=[d.U,d.F,d.R],X={EDGES:[new S("EDGES","UF",h(p.O,0)),new S("EDGES","UR",h(p.U,3)),new S("EDGES","UB",h(p.U,2)),new S("EDGES","UL",h(p.U,1)),new S("EDGES","DF",h(p.F,2)),new S("EDGES","DR",h(p.F,2).premultiply(h(p.D,1))),new S("EDGES","DB",h(p.F,2).premultiply(h(p.D,2))),new S("EDGES","DL",h(p.F,2).premultiply(h(p.D,3))),new S("EDGES","FR",h(p.U,3).premultiply(h(p.R,3))),new S("EDGES","FL",h(p.U,1).premultiply(h(p.R,3))),new S("EDGES","BR",h(p.U,3).premultiply(h(p.R,1))),new S("EDGES","BL",h(p.U,1).premultiply(h(p.R,1)))],CORNERS:[new S("CORNERS","UFR",h(p.O,0)),new S("CORNERS","URB",h(p.U,3)),new S("CORNERS","UBL",h(p.U,2)),new S("CORNERS","ULF",h(p.U,1)),new S("CORNERS","DRF",h(p.F,2).premultiply(h(p.D,1))),new S("CORNERS","DFL",h(p.F,2).premultiply(h(p.D,0))),new S("CORNERS","DLB",h(p.F,2).premultiply(h(p.D,3))),new S("CORNERS","DBR",h(p.F,2).premultiply(h(p.D,2)))],CENTERS:[new S("CENTERS","U",h(p.O,0)),new S("CENTERS","L",h(p.R,3).premultiply(h(p.U,1))),new S("CENTERS","F",h(p.R,3)),new S("CENTERS","R",h(p.R,3).premultiply(h(p.D,1))),new S("CENTERS","B",h(p.R,3).premultiply(h(p.D,2))),new S("CENTERS","D",h(p.R,2))]},he=1/3,re={EDGES:[[[0,4,6],[0,4,5]],[[3,5,7],[0,7,5]],[[2,4,8],[0,10,5]],[[1,3,7],[0,1,5]],[[2,4,2],[2,4,3]],[[3,5,1],[2,7,3]],[[0,4,0],[2,10,3]],[[1,3,1],[2,1,3]],[[3,5,4],[3,6,4]],[[1,3,4],[1,2,4]],[[1,9,4],[1,8,4]],[[3,11,4],[3,0,4]]],CORNERS:[[[0,5,6],[0,5,5],[0,6,5]],[[3,5,8],[0,8,5],[0,9,5]],[[2,3,8],[0,11,5],[0,0,5]],[[1,3,6],[0,2,5],[0,3,5]],[[3,5,2],[2,6,3],[2,5,3]],[[2,3,2],[2,3,3],[2,2,3]],[[1,3,0],[2,0,3],[2,11,3]],[[0,5,0],[2,9,3],[2,8,3]]],CENTERS:[[[0,4,7]],[[0,1,4]],[[0,4,4]],[[0,7,4]],[[0,10,4]],[[0,4,1]]]},ze=null;function qe(){return ze??(ze=new Me(_.foundationWidth,_.foundationWidth,_.foundationWidth))}function pe(){let n=new Q,t=.5;return n.setAttribute("position",new H(new Float32Array([t,t,0,-t,t,0,t,-t,0,-t,t,0,-t,-t,0,t,-t,0]),3)),n.setAttribute("uv",new H(new Float32Array([1,1,0,1,1,0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,1,1]),2)),n}var Te=null;function Ke(){return Te??(Te=pe())}var Z=class extends ee{constructor(e,r,i={}){super();this.kpuzzle=e;this.scheduleRenderCallback=r;if(this.options={...Ne},Object.assign(this.options,i),this.kpuzzle.name()!=="3x3x3")throw new Error(`Invalid puzzle for this Cube3D implementation: ${this.kpuzzle.name()}`);i.foundationSprite&&this.setSprite(i.foundationSprite),i.hintSprite&&this.setHintSprite(i.hintSprite),this.kpuzzleFaceletInfo={};for(let s in X){let o=[];this.kpuzzleFaceletInfo[s]=o,this.pieces[s]=X[s].map(this.createCubie.bind(this,s,o))}this.scale.set(he,he,he),this.options.experimentalStickeringMask&&this.setStickeringMask(this.options.experimentalStickeringMask),this.#i(),this.options.faceletScale&&this.experimentalSetFaceletScale(this.options.faceletScale)}kpuzzleFaceletInfo;pieces={};options;experimentalHintStickerMeshes=[];experimentalFoundationMeshes=[];setSpriteURL;sprite=new Promise(e=>{this.setSpriteURL=r=>{Ee.load(r,e)}});setSprite(e){this.sprite=e}setHintSpriteURL;hintSprite=new Promise(e=>{this.setHintSpriteURL=r=>{Ee.load(r,e)}});setHintSprite(e){this.hintSprite=e}#e=null;#t(){return this.#e??=pe()}#i(){if(this.options.initialHintFaceletsAnimation==="none"||this.options.initialHintFaceletsAnimation!=="always"&&De())return;let e=_.hintStickerElevation-_.stickerElevation;this.#t().translate(0,0,-e),setTimeout(()=>{let r=performance.now(),i=0,s=1e3;function o(c){return c*(2-c)}let a=()=>{let c=performance.now()-r,m=o(c/s)*e;this.#t().translate(0,0,m-i),i=m,c<s&&(requestAnimationFrame(a),this.scheduleRenderCallback?.())};a()},500)}experimentalSetStickerSpriteURL(e){this.setSpriteURL(e)}experimentalSetHintStickerSpriteURL(e){this.setHintSpriteURL(e)}setStickeringMask(e){if(e.specialBehaviour==="picture"){for(let r of Object.values(this.kpuzzleFaceletInfo))for(let i of r)for(let s of i){s.facelet.material=ne;let{hintFacelet:o}=s;o&&(o.material=ne)}return}this.options.experimentalStickeringMask=e;for(let[r,i]of Object.entries(e.orbits))for(let s=0;s<i.pieces.length;s++){let o=i.pieces[s];if(o){let a=this.kpuzzleFaceletInfo[r][s];for(let c=0;c<a.length;c++){let m=o.facelets[c];if(m){let f=a[c],b=typeof m=="string"?m:m?.mask;f.facelet.material=O[f.faceIdx].stickerMaterial[b];let M=typeof m=="string"?b:m.hintMask??b;f.hintFacelet&&(f.hintFacelet.material=O[f.faceIdx].hintStickerMaterial[M])}}}}this.scheduleRenderCallback&&this.scheduleRenderCallback()}experimentalUpdateOptions(e){if("showMainStickers"in e)throw new Error("Unimplemented");let r=e.showFoundation;if(typeof r<"u"&&this.options.showFoundation!==r){this.options.showFoundation=r;for(let a of this.experimentalFoundationMeshes)a.visible=r}let i=e.hintFacelets;if(typeof i<"u"&&this.options.hintFacelets!==i&&ge[i]){this.options.hintFacelets=i;for(let a of this.experimentalHintStickerMeshes)a.visible=i==="floating";this.scheduleRenderCallback()}let{experimentalStickeringMask:s}=e;typeof s<"u"&&(this.options.experimentalStickeringMask=s,this.setStickeringMask(s),this.scheduleRenderCallback());let{faceletScale:o}=e;typeof o<"u"&&this.experimentalSetFaceletScale(o)}onPositionChange(e){let r=e.pattern;for(let i in X){let s=X[i];for(let o=0;o<s.length;o++){let a=r.patternData[i].pieces[o];this.pieces[i][a].matrix.copy(X[i][o].matrix),this.pieces[i][a].matrix.multiply(_e[i][r.patternData[i].orientation[o]])}for(let o of e.movesInProgress){let a=o.move,c=O[He[a.family]].vector,m=new V().makeRotationAxis(c,-this.ease(o.fraction)*o.direction*a.amount*T/4);for(let f=0;f<s.length;f++){let b=this.kpuzzle.moveToTransformation(a.modified({amount:1})),M=b.transformationData[i].permutation[f];if(f!==M||b.transformationData[i].orientationDelta[f]!==0){let y=r.patternData[i].pieces[f];this.pieces[i][y].matrix.premultiply(m)}}}}this.scheduleRenderCallback()}createCubie(e,r,i,s){let o=[];r.push(o);let a=new te;if(this.options.showFoundation){let c=this.createCubieFoundation();a.add(c),this.experimentalFoundationMeshes.push(c)}for(let c=0;c<i.stickerFaces.length;c++){let m=this.createSticker(O[ue[c]],O[i.stickerFaces[c]],!1),f={faceIdx:i.stickerFaces[c],facelet:m};if(a.add(m),this.options.hintFacelets==="floating"){let b=this.createSticker(O[ue[c]],O[i.stickerFaces[c]],!0);a.add(b),f.hintFacelet=b,this.experimentalHintStickerMeshes.push(b)}if(this.options.experimentalStickeringMask?.specialBehaviour==="picture"&&re[e]&&re[e][s]&&re[e][s][c]){let[b,M,y]=re[e][s][c];(async()=>{let l=async F=>{let P=await(F?this.hintSprite:this.sprite),E=this.createSticker(O[ue[c]],O[i.stickerFaces[c]],F);E.material=new w({map:P,side:F?j:K,transparent:!0});let C=M/12,A=(M+1)/12,B=y/9,R=(y+1)/9,z=new J(C,B),x=new J(C,R),v=new J(A,R),u=new J(A,B);switch(b){case 1:{[z,x,v,u]=[x,v,u,z];break}case 2:{[z,x,v,u]=[v,u,z,x];break}case 3:{[z,x,v,u]=[u,z,x,v];break}}E.geometry.setAttribute("uv",new H(new Float32Array([v.x,v.y,x.x,x.y,u.x,u.y,x.x,x.y,z.x,z.y,u.x,u.y]),2)),a.add(E)};l(!0),l(!1)})()}o.push(f)}return a.matrix.copy(i.matrix),a.matrixAutoUpdate=!1,this.add(a),a}createCubieFoundation(){let e=qe();return new W(e,this.options.experimentalStickeringMask?.specialBehaviour==="picture"?Ve:We)}createSticker(e,r,i){let s=this.options.experimentalStickeringMask?.specialBehaviour==="picture"?pe():i?this.#t():Ke(),o=new W(s,i?r.hintStickerMaterial.regular:r.stickerMaterial.regular);return o.setRotationFromEuler(e.fromZ),o.position.copy(e.vector),o.position.multiplyScalar(i?this.options.experimentalStickeringMask?.specialBehaviour==="picture"?Le:_.hintStickerElevation:_.stickerElevation),o.scale.setScalar(le(this.options)),o}experimentalSetFoundationOpacity(e){this.experimentalFoundationMeshes[0].material.opacity=e}experimentalSetFaceletScale(e){this.options.faceletScale=e;for(let r of Object.values(this.kpuzzleFaceletInfo))for(let i of r)for(let s of i)s.facelet.scale.setScalar(le(this.options)),s.hintFacelet?.scale.setScalar(le(this.options))}ease(e){return ie(e)}};var Re=new w({side:K,color:0}),N=new w({visible:!1}),$=new w({vertexColors:!0});function fe(n,t,e){return Math.hypot(n[3*t]-n[3*e],n[3*t+1]-n[3*e+1],n[3*t+2]-n[3*e+2])}function Je(n,t,e,r){let i=fe(n,t,e),s=fe(n,e,r),o=fe(n,t,r),a=(i+s+o)/2;return Math.sqrt(a*(a-i)*(a-s)*(a-o))}function Qe(n){let t=0;for(let e=2;3*e<n.length;e++)t+=Je(n,0,1,e);return t}function Xe(n){let t=Math.hypot(n[0],n[1],n[2]);return n[0]/=t,n[1]/=t,n[2]/=t,n}function Ze(n,t){let e=new Array(3);return e[0]=n[1]*t[2]-n[2]*t[1],e[1]=n[2]*t[0]-n[0]*t[2],e[2]=n[0]*t[1]-n[1]*t[0],e}function $e(n){let t=[n[3]-n[0],n[4]-n[1],n[5]-n[2]],e=[n[6]-n[3],n[7]-n[4],n[8]-n[5]],r=Ze(t,e);return Xe(r)}function Ye(n,t){let e=[],r=new Array(3),i=new Array(3);for(let s=1;s<10;s++){for(let a=0;a<n.length;a+=3){let c=(a+n.length-3)%n.length,m=(a+3)%n.length;for(let l=0;l<3;l++)r[l]=n[c+l]-n[a+l],i[l]=n[m+l]-n[a+l];let f=Math.hypot(r[0],r[1],r[2]),b=Math.hypot(i[0],i[1],i[2]);for(let l=0;l<3;l++)r[l]/=f,i[l]/=b;let M=r[0]*i[0]+r[1]*i[1]+r[2]*i[2],y=t/Math.sqrt(1-M*M);for(let l=0;l<3;l++)e[a+l]=n[a+l]+(r[l]+i[l])*y}let o=!0;for(let a=0;o&&a<e.length;a+=3){let c=(a+3)%n.length,m=0;for(let f=0;f<3;f++){let b=n[c+f]-n[a+f],M=e[c+f]-e[a+f];m+=b*M}m<=0&&(o=!1)}if(o)return e;t/=2}return n}var oe=class{constructor(t,e){this.sz=t;this.tm=e;this.vertices=new Float32Array(9*t),this.uvs=void 0,this.colors=new Uint8Array(18*t),this.ind=new Uint8Array(t),this.pos=0,this.ipos=0}pos;ipos;vertices;colors;uvs;ind;add(t,e,r){this.vertices[this.pos]=t[3*e+0],this.vertices[this.pos+1]=t[3*e+1],this.vertices[this.pos+2]=t[3*e+2],this.colors[this.pos]=r>>16,this.colors[this.pos+1]=r>>8&255,this.colors[this.pos+2]=r&255,this.pos+=3}addUncolored(t,e){this.vertices[this.pos]=t[3*e+0],this.vertices[this.pos+1]=t[3*e+1],this.vertices[this.pos+2]=t[3*e+2],this.pos+=3}setind(t){this.ind[this.ipos++]=t}makePoly(t,e,r){let i=t;for(let s=1;3*(s+1)<i.length;s++)this.add(i,0,e),this.add(i,s,e),this.add(i,s+1,e),this.setind(r)}setAttributes(t){t.setAttribute("position",new H(this.vertices,3));let e=this.colors.subarray(0,9*this.sz);t.setAttribute("color",new H(e,3,!0))}makeGroups(t){t.clearGroups();for(let e=0;e<this.ipos;){let r=e++,i=this.ind[r];for(;this.ind[e]===i;)e++;t.addGroup(3*r,3*(e-r),i)}}saveOriginalColors(){this.colors.copyWithin(this.pos,0,this.pos)}},me=class{origColor;origColorStickeringMask;faceColor;texturePtr=void 0;twistVal=-1;stickerStart;stickerEnd;hintStart;hintEnd;foundationStart;foundationEnd;isDup;faceNum;constructor(t,e,r,i){this.isDup=!!e.isDup,this.faceNum=e.face,this.stickerStart=t.ipos;let s=new ce(e.color).getHex();this.origColor=s,this.origColorStickeringMask=s,i?.stickeringMask&&this.setStickeringMask(t,i.stickeringMask),this.faceColor=s;let o=this.stickerCoords(e.coords,r);t.makePoly(o,this.faceColor,this.isDup?4:0),this.stickerEnd=t.ipos}stickerCoords(t,e){return Ye(t.slice(),e)}hintCoords(t,e,r,i){t=this.stickerCoords(t,r),i=i.slice();for(let o=0;o<3;o++)i[o]*=.5*e;let s=new Array(t.length);for(let o=0;3*o<t.length;o++){let a=t.length/3-1-o;s[3*o]=t[3*a]+i[0],s[3*o+1]=t[3*a+1]+i[1],s[3*o+2]=t[3*a+2]+i[2]}return s}foundationCoords(t){let e=t.slice();for(let r=0;r<t.length;r++)e[r]=t[r]*.999;return e}addHint(t,e,r,i,s,o){this.hintStart=t.ipos;let a=this.hintCoords(e.coords,i,s,o);t.makePoly(a,this.faceColor,r&&!this.isDup?2:4),this.hintEnd=t.ipos}addFoundation(t,e,r){this.foundationStart=t.ipos;let i=this.foundationCoords(e.coords);t.makePoly(i,r,this.isDup?4:6),this.foundationEnd=t.ipos}setHintStickers(t,e){let r=this.isDup||!e?4:2;for(let i=this.hintStart;i<this.hintEnd;i++)t.ind[i]=r|t.ind[i]&1}setStickeringMask(t,e){let r=0;switch(e){case"regular":{r=this.origColor;break}case"dim":{this.origColor===16777215?r=14540253:r=new ce(this.origColor).multiplyScalar(.5).getHex();break}case"oriented":{r=16746751;break}case"ignored":{r=4473924;break}case"invisible":r=this.origColor}this.origColorStickeringMask=r;for(let i=9*this.stickerStart;i<9*this.stickerEnd;i+=3)t.colors[t.pos+i]=r>>16,t.colors[t.pos+i+1]=r>>8&255,t.colors[t.pos+i+2]=r&255;for(let i=9*this.hintStart;i<9*this.hintEnd;i+=3)t.colors[t.pos+i]=r>>16,t.colors[t.pos+i+1]=r>>8&255,t.colors[t.pos+i+2]=r&255;this.setHintStickers(t,e!=="invisible"&&!this.isDup)}addUVs(t){let e=t.uvs,r=t.vertices,i=new Array(3);for(let s=3*this.stickerStart;s<3*this.stickerEnd;s++){i[0]=r[3*s],i[1]=r[3*s+1],i[2]=r[3*s+2];let o=t.tm.getuv(this.faceNum,i);e[2*s]=o[0],e[2*s+1]=o[1]}for(let s=3*this.hintStart;s<3*this.hintEnd;s++){i[0]=r[3*s],i[1]=r[3*s+1],i[2]=r[3*s+2];let o=t.tm.getuv(this.faceNum,i);e[2*s]=o[0],e[2*s+1]=o[1]}}setTexture(t,e){if(this.texturePtr===e)return 0;this.texturePtr=e;let r=6*t.sz;return t.uvs.copyWithin(6*this.stickerStart,6*e.stickerStart+r,6*e.stickerEnd+r),t.uvs.copyWithin(6*this.hintStart,6*e.hintStart+r,6*e.hintEnd+r),1}setColor(t,e){let r=e.origColorStickeringMask;if(this.faceColor!==r){this.faceColor=r;let i=t.pos;return t.colors.copyWithin(9*this.stickerStart,9*e.stickerStart+i,9*e.stickerEnd+i),t.colors.copyWithin(9*this.hintStart,9*e.hintStart+i,9*e.hintEnd+i),1}else return 0}},de=class{cubie;geo;constructor(t,e,r){this.cubie=new te;let i=t.coords,s=new oe(i.length/3-2,e);for(let a=1;3*a+3<i.length;a++)s.addUncolored(i,0),s.addUncolored(i,a),s.addUncolored(i,a+1);this.geo=new Q,s.setAttributes(this.geo);let o=new W(this.geo,N);o.userData.quantumMove=r.notationMapper.notationToExternal(new ye(t.name)),this.cubie.scale.setScalar(.99),this.cubie.add(o)}},be=class{axis;order;constructor(t){let e=t.coordinates;this.axis=new D(e[0],e[1],e[2]),this.order=t.order}},et=.71,U=.5,Y=class extends ee{constructor(e,r,i,s=!1,o=!1,a=1,c=1,m={}){super();this.scheduleRenderCallback=e;this.kpuzzle=r;this.stickerDat=i;this.faceletScale=c;this.params=m;if(i.stickers.length===0)throw Error("Reuse of stickerdat from pg; please don't do that.");this.hintMaterial=new w({vertexColors:!0,transparent:!0,opacity:.5}),this.hintMaterialDisposable=!0,this.stickerMaterial=$,this.stickerMaterialDisposable=!1,this.axesInfo={};let f=this.stickerDat.axis;for(let u of f)this.axesInfo[u.quantumMove.family]=new be(u);let b=this.stickerDat.stickers;this.stickers={},this.materialArray1=new Array(8),this.materialArray2=new Array(8),this.showFoundation(s),s=!0;let M=0,y=3;for(let u of b){let g=u.coords.length/3;M+=y*(g-2)}let l=new oe(M,i.textureMapper),F=0,P=[],E=0;for(let u of i.faces)P.push($e(u.coords)),E+=Qe(u.coords);let C=c!=="auto"?c*c:et,A=0;for(let u of b)u.isDup||A++;let B=Math.sqrt(E/A)*(1-Math.sqrt(C))/2;for(let u of b){let g=u.orbit,k=u.ord,I=u.ori;this.stickers[g]||(this.stickers[g]=[]),this.stickers[g][I]||(this.stickers[g][I]=[]);let Se={};m.stickeringMask&&(Se.stickeringMask=ae(m.stickeringMask,g,k,I,!1));let Ce=new me(l,u,B,Se);this.stickers[g][I][k]=Ce}this.showHintStickers=o,o=!0;for(let u of b){let g=u.orbit,k=u.ord,I=u.ori;this.stickers[g][I][k].addHint(l,u,o,a,B,P[u.face])}this.foundationBound=l.ipos;for(let u of b){let g=u.orbit,k=u.ord,I=u.ori;s&&this.stickers[g][I][k].addFoundation(l,u,F)}let R=new Q;l.setAttributes(R),l.makeGroups(R);let z=new W(R,this.materialArray1);z.scale.set(U,U,U),this.add(z);let x=new W(R,this.materialArray2);x.scale.set(U,U,U),this.add(x);let v=this.stickerDat.faces;this.movingObj=x,this.fixedGeo=R,this.filler=l;for(let u of v){let g=new de(u,i.textureMapper,this.stickerDat);g.cubie.scale.set(U,U,U),this.add(g.cubie),this.controlTargets.push(g.cubie.children[0])}l.saveOriginalColors(),i.stickers=[],this.updateMaterialArrays()}stickers;axesInfo;stickerTargets=[];controlTargets=[];movingObj;filler;foundationBound;fixedGeo;lastPos;lastMoveTransformation;hintMaterial;stickerMaterial;materialArray1;materialArray2;textured=!1;showHintStickers=!1;showFoundations=!1;hintMaterialDisposable;stickerMaterialDisposable;#e=!1;isPG3DForTwisty3DPuzzleWrapper;dispose(){this.fixedGeo&&this.fixedGeo.dispose(),this.stickerMaterialDisposable&&(this.stickerMaterial.dispose(),this.stickerMaterial=$,this.stickerMaterialDisposable=!1),this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterial=$,this.hintMaterialDisposable=!1)}experimentalGetStickerTargets(){return this.stickerTargets}experimentalGetControlTargets(){return this.controlTargets}#t(e){try{return this.kpuzzle.moveToTransformation(e),!0}catch{return!1}}getClosestMoveToAxis(e,r){let i=null,s=0,o=c=>c;switch(r.depth){case"secondSlice":{o=c=>c.modified({innerLayer:2});break}case"rotation":{o=c=>c.modified({family:`${c.family}v`});break}}for(let c of this.stickerDat.axis){let m=e.dot(new D(...c.coordinates));if(m>s){let f=this.stickerDat.notationMapper.notationToExternal(o(c.quantumMove));if(!f)continue;this.#t(f)&&(s=m,i=f)}}if(!i)return null;r.invert&&(i=i.invert());let a=this.kpuzzle.moveToTransformation(i).repetitionOrder();return{move:i,order:a}}setStickeringMask(e){if(this.params.stickeringMask=e,e.specialBehaviour!=="picture")for(let r of this.kpuzzle.definition.orbits){let{numPieces:i,numOrientations:s}=r;for(let o=0;o<i;o++)for(let a=0;a<s;a++){let c=ae(e,r.orbitName,o,a,!1),m=this.stickers[r.orbitName][a][o];this.textured&&this.hintMaterialDisposable&&c==="invisible"||m.setStickeringMask(this.filler,c)}}this.#e=!0,this.lastPos&&this.onPositionChange(this.lastPos)}onPositionChange(e){let r=e.pattern.experimentalToTransformation();if(!r)throw new Error("indistinguishable pieces are not supported by PG3D yet");let i=new G;this.movingObj.rotation.copy(i);let s=0,o=this.filler,a=o.ind;if(!this.lastPos||this.#e||!this.lastPos.pattern.experimentalToTransformation().isIdentical(r)){for(let m in this.stickers){let f=this.stickers[m],b=r.transformationData[m],M=f.length;if(M===1){let y=f[0];for(let l=0;l<y.length;l++){let F=b.permutation[l];this.textured?s+=y[l].setTexture(o,y[F]):s+=y[l].setColor(o,y[F])}}else for(let y=0;y<M;y++){let l=f[y];for(let F=0;F<l.length;F++){let P=(y+M-b.orientationDelta[F])%M,E=b.permutation[F];this.textured?s+=l[F].setTexture(o,f[P][E]):s+=l[F].setColor(o,f[P][E])}}}this.lastPos=e}let c=0;for(let m of e.movesInProgress){let f=m.move,b=this.stickerDat.unswizzle(f);if(!b)return;let M=f,y;try{y=this.kpuzzle.moveToTransformation(M.modified({amount:1}))}catch(E){let C=this.stickerDat.notationMapper.notationToInternal(M);if(C){let A=this.stickerDat.notationMapper.notationToExternal(C.modified({amount:1}));A&&(y=this.kpuzzle.moveToTransformation(A))}if(!y)throw console.log(E),E}let l=this.axesInfo[b.family],F=l.axis,P=-this.ease(m.fraction)*m.direction*b.amount*T/l.order;if(this.movingObj.rotateOnAxis(F,P),this.lastMoveTransformation!==y){for(let E in this.stickers){let C=this.stickers[E],A=C.length,B=y.transformationData[E];for(let R=0;R<A;R++){let z=C[R];for(let x=0;x<z.length;x++){let v=z[x],u=B.permutation[x],g=0;if((u!==x||B.orientationDelta[x]!==0)&&(g=1),g!==v.twistVal){if(g){for(let k=v.stickerStart;k<v.stickerEnd;k++)a[k]|=1;for(let k=v.hintStart;k<v.hintEnd;k++)a[k]|=1;for(let k=v.foundationStart;k<v.foundationEnd;k++)a[k]|=1}else{for(let k=v.stickerStart;k<v.stickerEnd;k++)a[k]&=-2;for(let k=v.hintStart;k<v.hintEnd;k++)a[k]&=-2;for(let k=v.foundationStart;k<v.foundationEnd;k++)a[k]&=-2}v.twistVal=g,c++}}}}this.lastMoveTransformation=y}}(this.#e||c)&&this.filler.makeGroups(this.fixedGeo),(this.#e||s)&&(this.textured&&(this.fixedGeo.getAttribute("uv").updateRange={offset:0,count:6*this.foundationBound},this.fixedGeo.getAttribute("uv").needsUpdate=!0),(this.#e||!this.textured)&&(this.fixedGeo.getAttribute("color").updateRange={offset:0,count:9*this.foundationBound},this.fixedGeo.getAttribute("color").needsUpdate=!0)),this.scheduleRenderCallback(),this.#e=!1}ease(e){return ie(e)}showHintFacelets(e){this.showHintStickers=e}updateMaterialArrays(){for(let e=0;e<8;e++)this.materialArray1[e]=N,this.materialArray2[e]=N;this.materialArray1[0]=this.stickerMaterial,this.materialArray2[1]=this.stickerMaterial,this.showHintStickers?(this.materialArray1[2]=this.hintMaterial,this.materialArray2[3]=this.hintMaterial):(this.materialArray1[2]=N,this.materialArray2[3]=N),this.showFoundations?(this.materialArray1[6]=Re,this.materialArray2[7]=Re):(this.materialArray1[6]=N,this.materialArray2[7]=N)}showFoundation(e){this.showFoundations=e}setHintStickerOpacity(e){this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterialDisposable=!1),e===0?this.hintMaterial=N:e===1?this.hintMaterial=this.stickerMaterial:(this.hintMaterial=new w({vertexColors:!0,transparent:!0,opacity:e}),this.hintMaterialDisposable=!0)}experimentalUpdateOptions(e){e.hintFacelets!==void 0&&this.showHintFacelets(e.hintFacelets!=="none"),e.showFoundation!==void 0&&this.showFoundation(e.showFoundation),e.hintStickerOpacity!==void 0&&this.setHintStickerOpacity(e.hintStickerOpacity),this.#e=!0,this.lastPos&&this.onPositionChange(this.lastPos),typeof e.faceletScale<"u"&&e.faceletScale!==this.faceletScale&&console.warn("Dynamic facelet scale is not yet supported for PG3D. For now, re-create the TwistyPlayer to change the facelet scale."),this.updateMaterialArrays(),this.scheduleRenderCallback()}adduvs(){let e=this.filler;if(e.uvs)return;this.filler.uvs=new Float32Array(12*e.sz);for(let i in this.stickers){let s=this.stickers[i],o=s.length;for(let a=0;a<o;a++){let c=s[a];for(let m of c)m.addUVs(this.filler)}}e.uvs.copyWithin(6*e.sz,0,6*e.sz);let r=e.uvs.subarray(0,6*e.sz);this.fixedGeo.setAttribute("uv",new H(r,2,!0))}experimentalUpdateTexture(e,r,i){r||(e=!1),e&&!this.filler.uvs&&this.adduvs(),this.textured=e,this.stickerMaterialDisposable&&(this.stickerMaterial.dispose(),this.stickerMaterialDisposable=!1),e?(this.stickerMaterial=new w({map:r,side:q,transparent:!1}),this.stickerMaterialDisposable=!0):this.stickerMaterial=$,this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterialDisposable=!1),e?(this.hintMaterial=new w({map:i,side:q,transparent:!0}),this.hintMaterialDisposable=!0):this.hintMaterial=$,e&&this.showHintFacelets(i!==null),this.updateMaterialArrays(),this.#e=!0,this.lastPos&&this.onPositionChange(this.lastPos),this.scheduleRenderCallback()}};var ke=class{renderTargets=new Set;twisty3Ds=new Set;threeJSScene=(async()=>new(await Fe).Scene)();addRenderTarget(t){this.renderTargets.add(t)}scheduleRender(){for(let t of this.renderTargets)t.scheduleRender()}async addTwisty3DPuzzle(t){this.twisty3Ds.add(t),(await this.threeJSScene).add(t)}async removeTwisty3DPuzzle(t){this.twisty3Ds.delete(t),(await this.threeJSScene).remove(t)}async clearPuzzles(){for(let t of this.twisty3Ds)(await this.threeJSScene).remove(t);this.twisty3Ds.clear()}};async function Mt(n,t){return new Z(await ve.kpuzzle(),n,t)}async function xt(n,t,e,r,i){return new Y(n,await t.kpuzzle(),(await t.pg()).get3d({darkIgnoredOrbits:i}),!0,e==="floating",void 0,r)}export{Z as Cube3D,Y as PG3D,Ae as T3I,ke as Twisty3DScene,Mt as cube3DShim,xt as pg3dShim};
//# sourceMappingURL=twisty-dynamic-3d-UHULXLNW.js.map
